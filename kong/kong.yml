# Kong Declarative Configuration for CodeCave Production
# This file defines how Kong routes API requests to your backend services

_format_version: "3.0"
_transform: true

# Services define the backend APIs that Kong will proxy to
services:
  # Main NestJS API service
  - name: codecave-api
    url: http://api:3001
    protocol: http
    host: api
    port: 3001
    path: /

# Routes define how incoming requests are matched and forwarded to services
routes:
  # Main API routes - all requests go to the NestJS service
  - name: api-route
    service: codecave-api
    protocols: ["http", "https"]
    hosts: ["api.codecave.tech"]
    paths: ["/"]
    strip_path: false
    preserve_host: true
    
  # Health check route (public, no authentication)
  - name: health-route
    service: codecave-api
    protocols: ["http", "https"]
    hosts: ["api.codecave.tech"]
    paths: ["/health"]
    strip_path: false
    methods: ["GET"]

  # Sentry test routes (for monitoring setup)
  - name: sentry-route
    service: codecave-api
    protocols: ["http", "https"]  
    hosts: ["api.codecave.tech"]
    paths: ["/sentry-test", "/sentry-error", "/sentry-examples"]
    strip_path: false

# Plugins provide additional functionality like authentication, rate limiting, etc.
plugins:
  # CORS plugin for cross-origin requests from Vercel frontend
  - name: cors
    config:
      origins: 
        - "https://codecave.tech"
        - "https://www.codecave.tech"
        - "https://*.vercel.app"
        - "http://localhost:3000"
      methods: 
        - "GET"
        - "POST" 
        - "PUT"
        - "PATCH"
        - "DELETE"
        - "OPTIONS"
      headers:
        - "Accept"
        - "Accept-Version"
        - "Content-Length"
        - "Content-MD5"
        - "Content-Type"
        - "Date"
        - "Authorization"
        - "X-Auth-Token"
      exposed_headers:
        - "X-Auth-Token"
      credentials: true
      max_age: 3600

  # Rate limiting to prevent abuse
  - name: rate-limiting
    config:
      minute: 100
      hour: 1000
      policy: "local"
      fault_tolerant: true
      hide_client_headers: false

  # Request size limiting
  - name: request-size-limiting
    config:
      allowed_payload_size: 50

  # Add security headers
  - name: response-transformer
    config:
      add:
        headers:
          - "X-Content-Type-Options: nosniff"
          - "X-Frame-Options: DENY"
          - "X-XSS-Protection: 1; mode=block"
          - "Referrer-Policy: strict-origin-when-cross-origin"

  # Add request headers for forwarding
  - name: request-transformer
    config:
      add:
        headers:
          - "X-Forwarded-Proto: $scheme"
          - "X-Real-IP: $remote_addr" 